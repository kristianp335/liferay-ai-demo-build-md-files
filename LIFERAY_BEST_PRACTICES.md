# Liferay Development Best Practices

This document consolidates critical best practices and correct procedures for Liferay fragment and client extension development.

## 1. Check for Existing Implementations

Before building a new fragment, especially a complex one like a site header or footer, **always check for an existing implementation in the `.gemini` directory.**

This project contains pre-built, feature-rich fragments (e.g., `.gemini/sigma-header`) that provide a robust foundation for common needs. Reusing them can save significant development time.

### Benefits of Reusing
- **Feature-Complete:** These fragments often include complex features like dynamic navigation, mega menus, search modals, and responsive mobile views out-of-the-box.
- **Pre-Tested:** They have been tested and handle tricky edge cases like Liferay's edit mode and SPA navigation behavior.
- **Best Practices:** They serve as a working example of the best practices outlined in this guide.

### How to Adapt an Existing Fragment
1.  **Copy:** Copy the files from the example directory (e.g., `.gemini/sigma-header`) into your fragment collection (e.g., `everflow-liferay/fragments/everflow-collection/ef-header`).
2.  **Rename & Rebrand:** Perform a find-and-replace to change class prefixes (e.g., `sigma-` to `ef-`) and any hardcoded text (e.g., "Sigma Pharmaceuticals" to "Everflow").
3.  **Map CSS Variables:** In the fragment's CSS file, map the fragment-specific variables to the theme's global CSS variables to ensure the styling matches the rest of the site.
4.  **Update Resources:** Replace any hardcoded resources like logos with ones from your project's `resources` folder.

## 2. Fragment and Client Extension Structure

### Liferay Workspace Root Folder

**CRITICAL RULE**: The root Liferay workspace folder, typically named `liferay` (or similar, like `dxp`), **MUST NOT** be renamed. This folder is usually generated by a Liferay Blade command (e.g., `blade init`) and contains essential project configurations and subfolders (`modules`, `themes`, `configs`, etc.) that are expected by Liferay's tooling. Renaming this folder can lead to build failures, deployment issues, and problems with Liferay's developer workflows. Always maintain the original name of the Liferay workspace root folder.

### Fragment Collection Structure

A Liferay fragment collection **must** have a specific directory structure to be imported correctly.

```
collection-name/           # Root directory is REQUIRED
├── collection.json       # Collection metadata
├── fragments/
│   └── [fragment-name]/  # Directory for each fragment
│       ├── fragment.json
│       ├── configuration.json
│       ├── index.html
│       ├── index.css
│       ├── index.js
│       └── thumbnail.png
└── resources/            # Shared assets for all fragments
    ├── image-1.png
    └── icon.svg
```

### Client Extension File Structure

A client extension is used for global CSS and JavaScript. Each individual CSS or JavaScript file intended for site-wide inclusion must have its own client extension definition within the `client-extension.yaml`.

```
client-extension-name/
├── client-extension.yaml
└── assets/
    ├── css/
    │   ├── my-main.css
    │   └── global.css
    └── js/
        └── global.js
```

**Important Note on YAML Structure:** The `client-extension.yaml` file must define each extension (e.g., for each CSS and JS file) as its own top-level key. Do not group them under a single `client-extension:` key or attempt to list multiple CSS/JS files under a single `urls` property within one client extension definition; each file requires its own.

**Example `client-extension.yaml`:**
```yaml
assemble:
  - from: assets
    into: static

my-main-css:
  name: "My Main CSS"
  type: globalCSS
  url: "css/my-main.css"

my-global-css:
  name: "My Global CSS"
  type: globalCSS
  url: "css/global.css"

my-global-js:
  name: "My Global JS"
  type: globalJS
  url: "js/global.js"
  async: true
  data-senna-track: permanent
  fetchpriority: low
```
## 3. Configuration and Editable Content

Correctly configuring fragments is crucial. There are two key parts: the `configuration.json` file and the `data-lfr-editable-*` attributes in the HTML.

### Fragment Configuration (`configuration.json`)

This file defines the options that appear in the fragment's configuration sidebar. Each field must have a valid `type`.

**For a complete list of valid configuration types, see [LFR_CONFIGURATION_TYPES.md](LFR_CONFIGURATION_TYPES.md).**

### Editable Content (`data-lfr-editable-type`)

This HTML attribute makes an element directly editable by a content editor. Each editable element needs a `data-lfr-editable-id` and a `data-lfr-editable-type`.

**Avoiding Redundant Configuration Fields:**
If an HTML element has `data-lfr-editable-id` and `data-lfr-editable-type` attributes, its content (e.g., text, link URL, image source) **does not need to be duplicated as a configurable field in `configuration.json`**. The default value for that editable content should be provided directly in the `index.html`. Liferay's UI will handle allowing content editors to change this content directly on the page or through the fragment editor.

**For a complete list of valid editable types, see [LFR_EDITABLE_TYPES.md](LFR_EDITABLE_TYPES.md).**

## 4. Common Configuration Pitfalls

To avoid the most common import errors, follow these rules.

### Correct `configuration.json` Structure

The `fields` array must be nested inside a `fieldSets` array.

```json
{
    "fieldSets": [
        {
            "fields": [
                {
                    "name": "title",
                    "label": "Title",
                    "type": "text"
                }
            ]
        }
    ]
}
```

### Invalid Configuration Field Types

Do not use `image`, `link`, or `rich-text` as a `type` in `configuration.json`. These content types should only be defined as editable in the HTML. Having them in the configuration file will cause an error.

-   **For images:** Use `<img data-lfr-editable-type="image">`
-   **For links:** Use `<a data-lfr-editable-type="link">`
-   **For rich text:** Use `<div data-lfr-editable-type="rich-text">`

### FreeMarker Default Values

Always provide a default value in your `index.html` for every configuration variable to prevent errors if the variable is null.

-   **Incorrect:** `${configuration.title}`
-   **Correct:** `${configuration.title!'My Default Title'}`

## 5. CSS and Styling

### Liferay Classic Theme Tokens

To ensure consistency and allow for site-wide branding changes, custom styles should be based on the Liferay Classic theme's CSS tokens.

-   **Mapping:** Instead of hardcoding color values, map your fragment's CSS variables to the Liferay tokens.
    -   Example: `--my-fragment-primary-color: var(--primary);`
-   **Reference:** For a full list of available tokens, see [LFR_CLASSIC_THEME_TOKENS.md](LFR_CLASSIC_THEME_TOKENS.md).

### Fragment CSS Scoping

To prevent styles from one fragment affecting others, you **must manually add a wrapper `div`** with a unique class to the root of your fragment's `index.html`. All CSS rules in `index.css` should then be prefixed with this wrapper class.

-   **Example:**
    -   In `index.html`: `<div class="my-fragment-wrapper">...</div>`
    -   In `index.css`: `.my-fragment-wrapper .my-title { color: blue; }`

## 6. Asset Management

-   **Generate Placeholders:** Use the `nanobanana` tool (`generate_image`, `generate_icon`) to create default placeholder images for your fragment content and to generate a `thumbnail.png` for each fragment.
-   **Storage Location:** All static assets (images, SVGs, etc.) **must** be placed in the `resources/` directory at the root of the fragment collection.
-   **Reference Syntax:** To reference a resource from within a fragment's `index.html`, use the `[resources:filename.ext]` syntax.
-   **Do Not Use Relative Paths:** Never use relative paths (e.g., `../../resources/image.png`). This will fail upon deployment.

### Correct Implementation for an Editable Image:

```html
<img
   src="[resources:default-image.png]"
   alt="A descriptive alt text"
   data-lfr-editable-id="unique-editable-id"
   data-lfr-editable-type="image"
>
```

#### Font Handling Best Practices

Managing fonts efficiently is crucial for web performance. Liferay fragments and client extensions offer flexibility, but choosing between local hosting and web imports has implications.

**Local Font Hosting**
*   **Pros:** Full control over font files and serving; no external dependency.
*   **Cons:** Increases client extension size; requires manual updates.

**Web Font Imports (e.g., Google Fonts)**
*   **Pros:** Reduces client extension size; simplifies font management; leverages CDN benefits.
*   **Cons:** External dependency; potential privacy concerns; slight initial performance hit.

**Recommended Approach:**
1.  **Prioritize Web Imports for Common Fonts:** For widely available fonts (e.g., Roboto, Source Serif 4 from Google Fonts), prefer web imports using `@import` rules in your CSS.
2.  **Host Custom/Unique Fonts Locally (If Necessary):** For custom brand fonts or icon fonts not on reliable CDNs, host them locally.
    *   **Ensure Removal of Unused Local Fonts:** Regularly audit and remove local font files (`.woff2`, `.woff`, `.ttf`, `.otf`, `.svg`) not declared in CSS.
3.  **Use Fallback Fonts:** Always include generic fallback font families (e.g., `sans-serif`, `serif`) for graceful degradation.

#### Icon Best Practices

When working with icons in Liferay fragments, prioritize performance and maintainability.

*   **Prefer Hardcoded SVG Icons:** For optimal performance, scalability, and independence from external libraries or font files, hardcode SVG icons directly into your fragment's HTML. This eliminates network requests for icon fonts and provides maximum styling control.
    **Example (Direct Inline SVG):**
    ```html
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 1em; height: 1em; fill: currentColor;"><path d="M..."></path></svg>
    ```
*   **For Editable Icons:** If content editors need to change icons via the Liferay UI, consider using LFR editable image fields (refer to `LIFERAY_FRAGMENT_DEVELOPMENT_GUIDE.md` for example). For core UI elements, inline SVG is generally preferred.


## 7. Creating Deployment Packages (Zipping)

-   **Python Scripts:** Always use the dedicated Python scripts located in the project root to create the deployment packages.
    -   `create_fragment_collection_zip.py`: Used to package fragment collections.
    -   `create_client_extension_zip.py`: Used to package client extensions.
-   **Do Not Use Standard OS Tools:** Standard OS zipping tools can create archives that Liferay will silently fail to import.

## 8. Image Generation with `nanobanana`

-   **Size Limitation for `/generate`:** The `generate_image` tool consistently produces images at a fixed resolution of 1024x1024.
-   **Workaround:** Generate images at the default 1024x1024 size. The user must manually resize or crop the image after generation.
-   **For more details, see [nanobanana_guide.md](nanobanana_guide.md).**

## 9. Full DOM Extraction with `playwright`

-   **Purpose:** To accurately analyze a modern, JavaScript-heavy website, `web_fetch` is insufficient. A headless browser is required.
-   **For more details, see [playwright_guide.md](playwright_guide.md).**
